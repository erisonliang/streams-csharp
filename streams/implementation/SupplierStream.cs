//======================================================================================================================
namespace hhlogic.streams.implementation {
//----------------------------------------------------------------------------------------------------------------------
using System;
//======================================================================================================================


//======================================================================================================================
public sealed class SupplierStream<T> : AbstractFilterStream<T>
{
  //--------------------------------------------------------------------------------------------------------------------
  private Func<Maybe<T>> supplier;
  private Maybe<T> _head;
  private SupplierStream<T> _tail = null;
  private bool initialized = false;
  //--------------------------------------------------------------------------------------------------------------------
  public SupplierStream(Func<Maybe<T>> supplier)
  {
    this.supplier = supplier;
  }
  //--------------------------------------------------------------------------------------------------------------------
  public override bool forEachWhile(Predicate<T> f)
  {
    init();

    return _head
      .filter(v => f(v))
      .map(v => _tail.forEachWhile(f))
      .get(() => _head.isNotPresent());
  }
  //--------------------------------------------------------------------------------------------------------------------
  public override Maybe<T> head()
  {
    init();
    return _head;
  }
  //--------------------------------------------------------------------------------------------------------------------
  public override Stream<T> tail()
  {
    init();
    return _tail;
  }
  //--------------------------------------------------------------------------------------------------------------------
  public override Maybe<uint> fastCount()
  {
    return Maybe<uint>.nothing;
  }
  //--------------------------------------------------------------------------------------------------------------------
  private void init()
  {
    if(initialized)
      return;

    initialized = true;
    _head = supplier();
    _tail = new SupplierStream<T>(supplier);
  }
  //--------------------------------------------------------------------------------------------------------------------
}
//======================================================================================================================


//======================================================================================================================
} // End Namespace
//======================================================================================================================
